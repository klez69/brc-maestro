<!DOCTYPE html>
<html lang="pl">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Panel Administratora - Historia Odwiedzin</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<script src="../js/auth.js"></script>
	</head>
	<body class="bg-gray-100">
		<div class="min-h-screen flex">
			<!-- Sidebar -->
			<aside class="w-64 bg-gray-800 text-white p-6">
				<h2 class="text-2xl font-bold mb-8">Panel Admin</h2>
				<nav>
					<a href="dashboard.html" class="block py-2 hover:text-gray-300">Dashboard</a>
					<a href="visitors.html" class="block py-2 hover:text-gray-300">Odwiedzający</a>
					<a href="visitor_history.html" class="block py-2 hover:text-gray-300 text-yellow-400">Historia Odwiedzin</a>
					<button onclick="logout()" class="mt-8 w-full bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">
						Wyloguj
					</button>
				</nav>
			</aside>

			<!-- Main Content -->
			<main class="flex-1 p-8">
				<h1 class="text-3xl font-bold mb-8">Historia Odwiedzin</h1>

				<div class="bg-white rounded-lg shadow p-6 mb-8">
					<div class="mb-4 flex justify-between items-center">
						<h2 class="text-xl font-semibold">Filtrowanie historii</h2>
						<div class="flex items-center gap-4">
							<select id="daysFilter" class="border rounded p-2">
								<option value="1">Ostatni dzień</option>
								<option value="7" selected>Ostatni tydzień</option>
								<option value="30">Ostatni miesiąc</option>
							</select>
							<button onclick="loadVisitorHistory()" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
								<i class="fas fa-sync-alt mr-2"></i>Odśwież
							</button>
						</div>
					</div>
				</div>

				<div class="bg-white rounded-lg shadow p-6">
					<div class="mb-4 flex justify-between items-center">
						<h2 class="text-xl font-semibold">Historia odwiedzin</h2>
						<div class="flex items-center">
							<span id="totalEntries" class="bg-blue-500 text-white px-3 py-1 rounded">0 wpisów</span>
						</div>
					</div>

					<!-- Loading indicator -->
					<div id="loadingIndicator" class="text-center py-8 hidden">
						<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
						<p class="text-gray-600">Ładowanie danych...</p>
					</div>

					<!-- Error message container -->
					<div id="errorContainer" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded">
						<div class="flex items-center">
							<i class="fas fa-exclamation-circle mr-2"></i>
							<p id="errorMessage"></p>
						</div>
						<button onclick="dismissError()" class="mt-2 text-sm text-red-700 hover:text-red-800">
							Zamknij komunikat
						</button>
					</div>

					<div id="tableContainer" class="overflow-x-auto">
						<table class="min-w-full table-auto">
							<thead>
								<tr class="bg-gray-100">
									<th class="px-4 py-2 text-left">ID</th>
									<th class="px-4 py-2 text-left">Visitor ID</th>
									<th class="px-4 py-2 text-left">Strona</th>
									<th class="px-4 py-2 text-left">IP</th>
									<th class="px-4 py-2 text-left">Data odwiedzin</th>
								</tr>
							</thead>
							<tbody id="historyTableBody">
								<!-- Dane będą dodawane dynamicznie -->
							</tbody>
						</table>
					</div>

					<!-- Pagination -->
					<div class="mt-4 flex justify-between items-center">
						<div>
							<span id="paginationInfo">Wyświetlanie 0-0 z 0</span>
						</div>
						<div class="flex space-x-2">
							<button id="prevPageBtn" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50" disabled>
								Poprzednia
							</button>
							<button id="nextPageBtn" class="px-3 py-1 bg-gray-200 rounded disabled:opacity-50" disabled>
								Następna
							</button>
						</div>
					</div>
				</div>

				<!-- Debug Info Panel -->
				<div class="mt-8 bg-white rounded-lg shadow p-6">
					<h3 class="text-lg font-semibold mb-4">Informacje diagnostyczne</h3>
					<div id="debugInfo" class="text-sm font-mono bg-gray-100 p-4 rounded">
						<p>Ostatnie odświeżenie: <span id="lastUpdate">Nigdy</span></p>
						<p>Status połączenia: <span id="connectionStatus">Sprawdzanie...</span></p>
						<p>Błędy: <span id="errorLog">Brak</span></p>
					</div>
				</div>
			</main>
		</div>

		<script>
			// Funkcja sprawdzająca autoryzację
			function checkAuth() {
				const isLoggedInLocal = localStorage.getItem('adminLoggedIn') === 'true'
				const isLoggedInSession = sessionStorage.getItem('adminLoggedIn') === 'true'
				const isLoggedIn = isLoggedInLocal || isLoggedInSession

				if (!isLoggedIn) {
					window.location.href = 'login.html'
					return false
				}
				return true
			}

			// Wykonaj sprawdzenie autoryzacji natychmiast
			if (!checkAuth()) {
				throw new Error('Brak autoryzacji')
			}

			// Globalne zmienne
			let lastUpdateTime = null
			let errorCount = 0
			let currentPage = 1
			let totalEntries = 0
			let entriesPerPage = 20
			let currentData = []

			// Funkcja do formatowania daty
			function formatDate(dateString) {
				const date = new Date(dateString)
				return date.toLocaleString('pl-PL')
			}

			// Funkcja do wyświetlania błędów
			function showError(message) {
				const errorContainer = document.getElementById('errorContainer')
				const errorMessage = document.getElementById('errorMessage')
				const errorLog = document.getElementById('errorLog')

				errorMessage.textContent = message
				errorContainer.classList.remove('hidden')

				errorCount++
				errorLog.textContent = `${errorCount} błędów (ostatni: ${message})`
			}

			function dismissError() {
				document.getElementById('errorContainer').classList.add('hidden')
			}

			// Funkcja do aktualizacji statusu połączenia
			function updateConnectionStatus(status) {
				const connectionStatus = document.getElementById('connectionStatus')
				connectionStatus.textContent = status
				connectionStatus.className = status === 'Połączono' ? 'text-green-600' : 'text-red-600'
			}

			// Funkcja do aktualizacji czasu ostatniego odświeżenia
			function updateLastRefreshTime() {
				lastUpdateTime = new Date()
				document.getElementById('lastUpdate').textContent = lastUpdateTime.toLocaleString('pl-PL')
			}

			// Funkcja do pokazywania/ukrywania wskaźnika ładowania
			function toggleLoading(show) {
				document.getElementById('loadingIndicator').classList.toggle('hidden', !show)
				document.getElementById('tableContainer').classList.toggle('hidden', show)
			}

			// Funkcja do renderowania danych tablicy z paginacją
			function renderTable() {
				const tableBody = document.getElementById('historyTableBody')
				tableBody.innerHTML = ''

				const startIndex = (currentPage - 1) * entriesPerPage
				const endIndex = Math.min(startIndex + entriesPerPage, currentData.length)

				// Wyświetl informacje o paginacji
				document.getElementById('paginationInfo').textContent = `Wyświetlanie ${startIndex + 1}-${endIndex} z ${
					currentData.length
				}`

				// Aktualizuj stan przycisków paginacji
				document.getElementById('prevPageBtn').disabled = currentPage === 1
				document.getElementById('nextPageBtn').disabled = endIndex >= currentData.length

				// Dodaj dane do tabeli
				for (let i = startIndex; i < endIndex; i++) {
					const entry = currentData[i]
					const row = document.createElement('tr')
					row.className = i % 2 === 0 ? 'bg-white' : 'bg-gray-50'
					row.innerHTML = `
						<td class="border px-4 py-2">${entry.id}</td>
						<td class="border px-4 py-2">${entry.visitor_id}</td>
						<td class="border px-4 py-2">${entry.page}</td>
						<td class="border px-4 py-2">${entry.ip_address}</td>
						<td class="border px-4 py-2">${formatDate(entry.visit_time)}</td>
					`
					tableBody.appendChild(row)
				}
			}

			// Obsługa paginacji
			document.getElementById('prevPageBtn').addEventListener('click', () => {
				if (currentPage > 1) {
					currentPage--
					renderTable()
				}
			})

			document.getElementById('nextPageBtn').addEventListener('click', () => {
				if (currentPage * entriesPerPage < currentData.length) {
					currentPage++
					renderTable()
				}
			})

			// Funkcja do ładowania historii odwiedzin
			async function loadVisitorHistory() {
				toggleLoading(true)
				currentPage = 1

				try {
					const daysFilter = document.getElementById('daysFilter').value
					const response = await fetch(`../track_visit.php?action=history&days=${daysFilter}&limit=1000`)

					if (!response.ok) {
						throw new Error(`Błąd HTTP: ${response.status}`)
					}

					const data = await response.json()
					if (data.status === 'error') {
						throw new Error(data.message || 'Wystąpił nieznany błąd')
					}

					currentData = data.history
					totalEntries = currentData.length
					document.getElementById('totalEntries').textContent = `${totalEntries} wpisów`

					renderTable()

					// Aktualizuj status i czas
					updateConnectionStatus('Połączono')
					updateLastRefreshTime()
					dismissError()
				} catch (error) {
					console.error('Błąd podczas pobierania danych:', error)
					showError(`Błąd podczas pobierania danych: ${error.message}`)
					updateConnectionStatus('Błąd połączenia')
				} finally {
					toggleLoading(false)
				}
			}

			// Inicjalizacja przy załadowaniu strony
			document.addEventListener('DOMContentLoaded', function () {
				// Załaduj dane przy starcie
				loadVisitorHistory()

				// Dodaj listener do zmiany filtra dni
				document.getElementById('daysFilter').addEventListener('change', loadVisitorHistory)
			})
		</script>
	</body>
</html>
